{"remainingRequest":"/Users/h/partTimeJob/exchange-fe-server-privatization-master/node_modules/thread-loader/dist/cjs.js!/Users/h/partTimeJob/exchange-fe-server-privatization-master/node_modules/babel-loader/lib/index.js!/Users/h/partTimeJob/exchange-fe-server-privatization-master/node_modules/eslint-loader/index.js??ref--13-0!/Users/h/partTimeJob/BlockChain-ui-privatization/PC/common-mixin/otcDetailOrder/chat/chat.js","dependencies":[{"path":"/Users/h/partTimeJob/BlockChain-ui-privatization/PC/common-mixin/otcDetailOrder/chat/chat.js","mtime":499162500000},{"path":"/Users/h/partTimeJob/exchange-fe-server-privatization-master/babel.config.js","mtime":1620459862000},{"path":"/Users/h/partTimeJob/exchange-fe-server-privatization-master/node_modules/cache-loader/dist/cjs.js","mtime":499162500000},{"path":"/Users/h/partTimeJob/exchange-fe-server-privatization-master/node_modules/thread-loader/dist/cjs.js","mtime":499162500000},{"path":"/Users/h/partTimeJob/exchange-fe-server-privatization-master/node_modules/babel-loader/lib/index.js","mtime":315532800000},{"path":"/Users/h/partTimeJob/exchange-fe-server-privatization-master/node_modules/eslint-loader/index.js","mtime":499162500000}],"contextDependencies":[],"result":["import \"core-js/modules/es6.function.name\";\nimport _toConsumableArray from \"/Users/h/partTimeJob/exchange-fe-server-privatization-master/node_modules/@babel/runtime-corejs2/helpers/esm/toConsumableArray\";\nimport \"core-js/modules/web.dom.iterable\";\nimport \"core-js/modules/es6.regexp.to-string\";\nimport \"core-js/modules/es6.number.constructor\";\nimport { timeFn } from '@/utils';\nexport default {\n  data: function data() {\n    return {\n      userScrollOpt: {\n        detectResize: true,\n        scrollPanel: {\n          initialScrollY: 999999,\n          initialScrollX: false,\n          scrollingX: true,\n          scrollingY: true,\n          speed: 300,\n          easing: undefined,\n          verticalNativeBarPos: 'right'\n        }\n      },\n      tab: '',\n      // server客服 user商家\n      serverData: [],\n      serverInp: '',\n      serverBtnLoading: false,\n      serverTimer: null,\n      serverScroll: false,\n      userBtnLoading: false,\n      userWs: null,\n      userWsReady: false,\n      //\n      userData: [],\n      // 商户数据\n      userInp: '',\n      // 商户框\n      chatId: '',\n      // ws信息\n      userTime: null,\n      // 发送ws消息的time 用于loding的过程\n      wsTime: null,\n      // 用于重新连接ws\n      sendTimer: null,\n      // 商家聊天 若五秒没从服务端返\n      resetTimer: null,\n      // 商家聊天 若在三秒内重复创建\n      chatHeight: 684,\n      userTimes: null // 发送消息倒计时\n\n    };\n  },\n  props: {\n    // 1-5 为正常流程  6是服务端状态  7为异常订单 8按3处理(客服介入强制使订单完成)\n    // 待支付1 已支付2 交易成功3 取消 4 申诉 5 打币中6 异常订单7 申诉处理结束8\n    commonData: {\n      default: function _default() {\n        return {};\n      },\n      type: Object\n    },\n    // 当前订单 是买数字货币BUY 还是卖数字货币SELL\n    isReady: {\n      default: false,\n      type: Boolean\n    },\n    chatTop: {\n      default: 0,\n      type: Number\n    }\n  },\n  filters: {\n    setTime: function setTime(v) {\n      return timeFn(new Date(Number(v)), 'yyyy-MM-dd hh:mm:ss');\n    }\n  },\n  watch: {\n    status: function status(v) {\n      if (v === '5' && this.commonData.isComplainUser.toString() === '1') {\n        this.tab = 'server';\n      } else {\n        this.tab = 'user';\n      }\n    },\n    tab: function tab(v) {\n      if (v === 'server') {\n        // 清除 商家聊天 若五秒没从服务端返回相同数据的后续操作\n        if (this.sendTimer) {\n          clearTimeout(this.sendTimer);\n        } // 清除 商家聊天 若在三秒内重复创建ws的后续操作\n\n\n        if (this.resetTimer) {\n          clearTimeout(this.resetTimer);\n        } // 如果 商家聊天 ws已经创建好了，则给他断开\n\n\n        if (this.userWsReady) {\n          this.userWs.close();\n        } // 获取 客服聊天数据\n\n\n        this.getServerData();\n        this.serverScroll = true;\n      } else if (v === 'user') {\n        // 清除 循环请求客服聊天数据\n        if (this.serverTimer) {\n          clearInterval(this.serverTimer);\n        } // 创建ws并且请求历史数据\n\n\n        this.initUser();\n      }\n    }\n  },\n  computed: {\n    userVip: function userVip() {\n      var str = '';\n\n      if (this.userInfo && this.userInfo.otcCompanyInfo) {\n        if (Number(this.userInfo.otcCompanyInfo.status)) {\n          if (this.userMess.companyLevel === 1) {\n            str = \"<svg class=\\\"icon icon-16\\\" aria-hidden=\\\"true\\\">\\n              <use xlink:href=\\\"#icon-c_16\\\"></use>\\n            </svg>\";\n          } else if (this.userMess.companyLevel === 2) {\n            str = \"<svg class=\\\"icon icon-16\\\" aria-hidden=\\\"true\\\">\\n              <use xlink:href=\\\"#icon-c_17\\\"></use>\\n            </svg>\";\n          }\n        }\n      }\n\n      return str;\n    },\n    userInfo: function userInfo() {\n      return this.$store.state.baseData.userInfo;\n    },\n    serverMy: function serverMy() {\n      var obj = {};\n\n      if (this.commonData.side === 'BUY') {\n        obj = this.commonData.buyer;\n      } else {\n        obj = this.commonData.seller;\n      }\n\n      return obj;\n    },\n    userMess: function userMess() {\n      var obj = {};\n\n      if (this.commonData.side === 'BUY') {\n        obj = this.commonData.seller;\n      } else if (this.commonData.side === 'SELL') {\n        obj = this.commonData.buyer;\n      }\n\n      return obj;\n    },\n    otcWsUrl: function otcWsUrl() {\n      var str = '';\n\n      if (this.$store.state.baseData.otcPublicInfo) {\n        str = this.$store.state.baseData.otcPublicInfo.otcChatWS;\n      }\n\n      return str; // return 'wss://ws2.chaindown.com/otc-chat/chatServer'\n    },\n    serverBtnDisabled: function serverBtnDisabled() {\n      var flag = true;\n\n      if (this.serverInp.length || this.serverBtnLoading) {\n        flag = false;\n      }\n\n      return flag;\n    },\n    userBtnDisabled: function userBtnDisabled() {\n      var flag = true;\n\n      if (this.userInp.length || this.userBtnLoading) {\n        flag = false;\n      }\n\n      return flag;\n    },\n    status: function status() {\n      if (this.commonData.status) {\n        return this.commonData.status.toString();\n      }\n\n      return '0';\n    },\n    chatUserHeight: function chatUserHeight() {\n      if (this.status === '5' && this.commonData.isComplainUser.toString() === '1') {\n        return this.chatHeight - 50 - 86 - 60;\n      }\n\n      return this.chatHeight - 86 - 60;\n    },\n    chatServerHeight: function chatServerHeight() {\n      return this.chatHeight - 50 - 60 - 6;\n    },\n    userSide: function userSide() {\n      var from = '';\n      var to = '';\n\n      if (this.commonData.side === 'BUY') {\n        from = this.commonData.buyer.uid.toString();\n        to = this.commonData.seller.uid.toString();\n      } else if (this.commonData.side === 'SELL') {\n        from = this.commonData.seller.uid.toString();\n        to = this.commonData.buyer.uid.toString();\n      }\n\n      return {\n        from: from,\n        to: to\n      };\n    }\n  },\n  beforeDestroy: function beforeDestroy() {\n    this.beforeDestroyMethods();\n  },\n  methods: {\n    beforeDestroyMethods: function beforeDestroyMethods() {\n      // 如果 商家聊天 ws已经创建好了，则给他断开\n      this.tab = '';\n\n      if (this.userWsReady) {\n        this.userWs.close();\n      }\n\n      this.userWs = null;\n      clearInterval(this.serverTimer);\n      clearTimeout(this.sendTimer);\n      clearTimeout(this.resetTimer);\n    },\n    goUid: function goUid(id) {\n      if (id) {\n        this.$router.push(\"/stranger?uid=\".concat(id));\n      }\n    },\n    userInpKeyup: function userInpKeyup(e) {\n      if (e.keyCode === 13) {\n        this.$bus.$emit('button-click', 'userButton');\n      }\n    },\n    serverInpKeyup: function serverInpKeyup(e) {\n      if (e.keyCode === 13) {\n        this.$bus.$emit('button-click', 'serverButton');\n      }\n    },\n    // aaa() {\n    //   this.userWs.close()\n    // },\n    userBtnClick: function userBtnClick() {\n      var _this = this;\n\n      if (this.userWsReady) {\n        this.userBtnLoading = true;\n        this.sendTimer = setTimeout(function () {\n          if (_this.userBtnLoading) {\n            _this.userBtnLoading = false;\n\n            if (_this.userWs && _this.userWsReady) {\n              _this.userWs.close();\n\n              _this.userInp = '';\n            }\n          }\n        }, 5000);\n        this.userTime = new Date().getTime();\n        this.userWs.send(JSON.stringify({\n          chatId: this.chatId,\n          message: {\n            content: this.userInp,\n            from: this.userSide.from,\n            to: this.userSide.to,\n            // 接收人,如果没有则置空,如果有多个接收人则用,分隔\n            orderId: this.commonData.sequence,\n            time: this.userTime\n          },\n          type: 'message'\n        }));\n      }\n    },\n    getUserData: function getUserData() {\n      var _this2 = this;\n\n      this.axios({\n        url: '/chatMsg/message',\n        method: 'post',\n        params: {\n          fromId: this.userSide.from,\n          toId: this.userSide.to,\n          orderId: this.commonData.sequence\n        },\n        hostType: 'otc'\n      }).then(function (data) {\n        if (data.code.toString() === '0') {\n          var arr = [];\n          data.data.forEach(function (v) {\n            var obj = {};\n\n            if (_this2.commonData.side === 'BUY') {\n              obj = v.fromId === _this2.userSide.from ? _this2.commonData.buyer : _this2.commonData.seller;\n            } else {\n              obj = v.fromId === _this2.userSide.from ? _this2.commonData.seller : _this2.commonData.buyer;\n            }\n\n            arr.push({\n              replayContent: v.content,\n              // 追 问内容\n              contentType: '1',\n              // 1-文字内容 2-图片url\n              userType: v.fromId === _this2.userSide.from ? '2' : '1',\n              // 用户类型：1-后台用户 2-前端用户\n              ctime: v.ctime,\n              // 提交时间\n              obj: obj\n            });\n          });\n          _this2.userData = arr;\n\n          _this2.$nextTick(function () {\n            _this2.$refs.userMessage.scrollTo({\n              y: '100%'\n            }, false);\n          });\n        } else {\n          _this2.$bus.$emit('tip', {\n            text: data.msg,\n            type: 'error'\n          });\n        }\n      });\n    },\n    // 创建商家聊天 / 创建ws\n    initUser: function initUser() {\n      var _this3 = this;\n\n      if (this.tab !== 'user') {\n        return;\n      }\n\n      this.getUserData(); // 获取历史数据\n      // 创建ws\n\n      if (this.otcWsUrl.length) {\n        this.userWs = null; // 重置\n\n        this.wsTime = new Date().getTime(); // 记录下创建时间 用于避免高频率创建\n\n        var str = this.userSide.from + this.userSide.to; // 自己的id + 对方的id\n        // console.log('create');\n        // 开始创建\n\n        this.userWs = new WebSocket(\"\".concat(this.otcWsUrl, \"/\").concat(window.btoa(str))); // 已经创建\n\n        this.userWs.onopen = function () {\n          if (_this3.tab !== 'user') {\n            return;\n          }\n\n          _this3.userWsReady = true;\n        }; // 接收数据\n\n\n        this.userWs.onmessage = function (ev) {\n          if (_this3.tab !== 'user') {\n            return;\n          }\n\n          if (ev.data) {\n            var data = JSON.parse(ev.data);\n            _this3.chatId = data.chatId;\n\n            if (data.message) {\n              if (Number(data.message.time) === Number(_this3.userTime)) {\n                _this3.userBtnLoading = false;\n                _this3.userInp = '';\n              }\n\n              var obj = {};\n\n              if (_this3.commonData.side === 'BUY') {\n                obj = data.message.from === _this3.userSide.from ? _this3.commonData.buyer : _this3.commonData.seller;\n              } else {\n                obj = data.message.from === _this3.userSide.from ? _this3.commonData.seller : _this3.commonData.buyer;\n              }\n\n              _this3.userData.push({\n                replayContent: data.message.content,\n                // 追 问内容\n                contentType: '1',\n                // 1-文字内容 2-图片url\n                userType: data.message.from === _this3.userSide.from ? '2' : '1',\n                // 用户类型：1-后台用户 2-前端用户\n                ctime: data.message.time,\n                // 提交时间\n                obj: obj\n              });\n\n              _this3.$nextTick(function () {\n                _this3.$refs.userMessage.scrollTo({\n                  y: '100%'\n                }, false);\n              });\n            }\n          }\n        }; // 一旦发现错误就关闭\n\n\n        this.userWs.onerror = function () {\n          if (_this3.tab !== 'user') {\n            return;\n          }\n\n          _this3.userWs.close();\n        }; // 错误处理\n\n\n        this.userWs.onclose = function () {\n          if (_this3.tab !== 'user') {\n            return;\n          }\n\n          _this3.userWsReady = false;\n          var nowTime = new Date().getTime();\n          var spk = nowTime - _this3.wsTime; // 避免高频率创建\n\n          if (spk > 3000) {\n            _this3.initUser();\n          } else {\n            // 如果切到客服 或者退出 这个倒计时就没有必要继续了\n            _this3.resetTimer = setTimeout(function () {\n              clearTimeout(_this3.resetTimer);\n\n              _this3.initUser();\n            }, 3000 - spk);\n          }\n        };\n      }\n    },\n    serverBtnClick: function serverBtnClick() {\n      var _this4 = this;\n\n      this.serverBtnLoading = true;\n      this.axios({\n        url: '/question/reply_create',\n        method: 'post',\n        params: {\n          rqId: this.commonData.complainId,\n          rqReplyContent: this.serverInp,\n          contentType: '1'\n        }\n      }).then(function (data) {\n        _this4.serverBtnLoading = false;\n\n        if (data.code.toString() === '0') {\n          _this4.serverScroll = true;\n\n          _this4.getServerData();\n\n          _this4.serverInp = '';\n        } else {\n          _this4.$bus.$emit('tip', {\n            text: data.msg,\n            type: 'error'\n          });\n        }\n      });\n    },\n    setTab: function setTab(v) {\n      this.tab = v;\n    },\n    getServerData: function getServerData() {\n      var _this5 = this;\n\n      clearInterval(this.serverTimer);\n      this.axiosServer();\n      this.serverTimer = setInterval(function () {\n        _this5.axiosServer(true);\n      }, 3000);\n    },\n    axiosServer: function axiosServer(auto) {\n      var _this6 = this;\n\n      var headers = {};\n\n      if (auto) {\n        headers['exchange-auto'] = '1';\n      }\n\n      this.axios({\n        url: '/question/details_problem',\n        headers: headers,\n        params: {\n          id: this.commonData.complainId\n        }\n      }).then(function (data) {\n        if (data.code.toString() === '0') {\n          var arr = [];\n\n          if (data.data.rqInfo) {\n            arr.push({\n              replayContent: data.data.rqInfo.rqDescribe,\n              // 追 问内容\n              contentType: '1',\n              // 1-文字内容 2-图片url\n              userType: '2',\n              // 用户类型：1-后台用户 2-前端用户\n              ctime: data.data.rqInfo.ctime // 提交时间\n\n            });\n          }\n\n          _this6.serverData = [].concat(arr, _toConsumableArray(data.data.rqReplyList));\n\n          _this6.$nextTick(function () {\n            if (_this6.serverScroll) {\n              _this6.serverScroll = false;\n\n              _this6.$refs.serverMessage.scrollTo({\n                y: '100%'\n              }, false);\n            }\n          });\n        } else {\n          _this6.$bus.$emit('tip', {\n            text: data.msg,\n            type: 'error'\n          });\n        }\n      });\n    },\n    // 上传图片\n    fileChange: function fileChange(e) {\n      var _this7 = this;\n\n      var fileSize = e.srcElement.files[0].size / 1024 / 1024;\n\n      if (fileSize <= 2) {\n        var from = new FormData();\n        from.append('file', this.$refs.fileInp.files[0], this.$refs.fileInp.files[0].name); // if (this.$store.state.baseData.publicInfo.uploadFlag === '1') {\n        //   ajaxUrl = window.HOST_API.updata_url\n        //   hostType = 'upload'\n        // }\n\n        this.axios({\n          url: 'common/upload_img',\n          headers: {\n            'Content-Type': 'multipart/form-data'\n          },\n          params: from,\n          method: 'post'\n        }).then(function (data) {\n          if (data.code === '0') {\n            _this7.axios({\n              url: '/question/reply_create',\n              method: 'post',\n              params: {\n                rqId: _this7.commonData.complainId,\n                rqReplyContent: data.data.filename,\n                contentType: '2'\n              }\n            }).then(function (cdata) {\n              if (cdata.code.toString() === '0') {\n                _this7.serverScroll = true;\n\n                _this7.getServerData();\n              } else {\n                _this7.$bus.$emit('tip', {\n                  text: cdata.msg,\n                  type: 'error'\n                });\n              }\n            });\n          } else {\n            _this7.$bus.$emit('tip', {\n              text: data.msg,\n              type: 'error'\n            });\n          }\n        });\n      } else {\n        this.$bus.$emit('tip', {\n          text: '请上传2MB以内的图片',\n          type: 'warning'\n        });\n      }\n    }\n  }\n};",null]}