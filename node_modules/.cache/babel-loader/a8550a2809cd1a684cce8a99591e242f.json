{"remainingRequest":"/Users/h/partTimeJob/exchange-fe-server-privatization-master/node_modules/babel-loader/lib/index.js!/Users/h/partTimeJob/exchange-fe-server-privatization-master/node_modules/eslint-loader/index.js??ref--13-0!/Users/h/partTimeJob/blockchain-ui-privatization/PC/common-mixin/otcDetailOrder/chat/chat.js","dependencies":[{"path":"/Users/h/partTimeJob/blockchain-ui-privatization/PC/common-mixin/otcDetailOrder/chat/chat.js","mtime":499162500000},{"path":"/Users/h/partTimeJob/exchange-fe-server-privatization-master/babel.config.js","mtime":1620459862000},{"path":"/Users/h/partTimeJob/exchange-fe-server-privatization-master/node_modules/cache-loader/dist/cjs.js","mtime":499162500000},{"path":"/Users/h/partTimeJob/exchange-fe-server-privatization-master/node_modules/babel-loader/lib/index.js","mtime":315532800000},{"path":"/Users/h/partTimeJob/exchange-fe-server-privatization-master/node_modules/eslint-loader/index.js","mtime":499162500000}],"contextDependencies":[],"result":["import \"core-js/modules/es6.function.name\";\nimport _toConsumableArray from \"/Users/h/partTimeJob/exchange-fe-server-privatization-master/node_modules/@babel/runtime-corejs2/helpers/esm/toConsumableArray\";\nimport \"core-js/modules/web.dom.iterable\";\nimport \"core-js/modules/es6.regexp.to-string\";\nimport \"core-js/modules/es6.number.constructor\";\nimport { timeFn } from '@/utils';\nexport default {\n  data: function data() {\n    return {\n      userScrollOpt: {\n        detectResize: true,\n        scrollPanel: {\n          initialScrollY: 999999,\n          initialScrollX: false,\n          scrollingX: true,\n          scrollingY: true,\n          speed: 300,\n          easing: undefined,\n          verticalNativeBarPos: 'right'\n        }\n      },\n      tab: '',\n      // server客服 user商家\n      serverData: [],\n      serverInp: '',\n      serverBtnLoading: false,\n      serverTimer: null,\n      serverScroll: false,\n      userBtnLoading: false,\n      userWs: null,\n      userWsReady: false,\n      //\n      userData: [],\n      // 商户数据\n      userInp: '',\n      // 商户框\n      chatId: '',\n      // ws信息\n      userTime: null,\n      // 发送ws消息的time 用于loding的过程\n      wsTime: null,\n      // 用于重新连接ws\n      sendTimer: null,\n      // 商家聊天 若五秒没从服务端返\n      resetTimer: null,\n      // 商家聊天 若在三秒内重复创建\n      chatHeight: 684,\n      userTimes: null // 发送消息倒计时\n\n    };\n  },\n  props: {\n    // 1-5 为正常流程  6是服务端状态  7为异常订单 8按3处理(客服介入强制使订单完成)\n    // 待支付1 已支付2 交易成功3 取消 4 申诉 5 打币中6 异常订单7 申诉处理结束8\n    commonData: {\n      default: function _default() {\n        return {};\n      },\n      type: Object\n    },\n    // 当前订单 是买数字货币BUY 还是卖数字货币SELL\n    isReady: {\n      default: false,\n      type: Boolean\n    },\n    chatTop: {\n      default: 0,\n      type: Number\n    }\n  },\n  filters: {\n    setTime: function setTime(v) {\n      return timeFn(new Date(Number(v)), 'yyyy-MM-dd hh:mm:ss');\n    }\n  },\n  watch: {\n    status: function status(v) {\n      if (v === '5' && this.commonData.isComplainUser.toString() === '1') {\n        this.tab = 'server';\n      } else {\n        this.tab = 'user';\n      }\n    },\n    tab: function tab(v) {\n      if (v === 'server') {\n        // 清除 商家聊天 若五秒没从服务端返回相同数据的后续操作\n        if (this.sendTimer) {\n          clearTimeout(this.sendTimer);\n        } // 清除 商家聊天 若在三秒内重复创建ws的后续操作\n\n\n        if (this.resetTimer) {\n          clearTimeout(this.resetTimer);\n        } // 如果 商家聊天 ws已经创建好了，则给他断开\n\n\n        if (this.userWsReady) {\n          this.userWs.close();\n        } // 获取 客服聊天数据\n\n\n        this.getServerData();\n        this.serverScroll = true;\n      } else if (v === 'user') {\n        // 清除 循环请求客服聊天数据\n        if (this.serverTimer) {\n          clearInterval(this.serverTimer);\n        } // 创建ws并且请求历史数据\n\n\n        this.initUser();\n      }\n    }\n  },\n  computed: {\n    userVip: function userVip() {\n      var str = '';\n\n      if (this.userInfo && this.userInfo.otcCompanyInfo) {\n        if (Number(this.userInfo.otcCompanyInfo.status)) {\n          if (this.userMess.companyLevel === 1) {\n            str = \"<svg class=\\\"icon icon-16\\\" aria-hidden=\\\"true\\\">\\n              <use xlink:href=\\\"#icon-c_16\\\"></use>\\n            </svg>\";\n          } else if (this.userMess.companyLevel === 2) {\n            str = \"<svg class=\\\"icon icon-16\\\" aria-hidden=\\\"true\\\">\\n              <use xlink:href=\\\"#icon-c_17\\\"></use>\\n            </svg>\";\n          }\n        }\n      }\n\n      return str;\n    },\n    userInfo: function userInfo() {\n      return this.$store.state.baseData.userInfo;\n    },\n    serverMy: function serverMy() {\n      var obj = {};\n\n      if (this.commonData.side === 'BUY') {\n        obj = this.commonData.buyer;\n      } else {\n        obj = this.commonData.seller;\n      }\n\n      return obj;\n    },\n    userMess: function userMess() {\n      var obj = {};\n\n      if (this.commonData.side === 'BUY') {\n        obj = this.commonData.seller;\n      } else if (this.commonData.side === 'SELL') {\n        obj = this.commonData.buyer;\n      }\n\n      return obj;\n    },\n    otcWsUrl: function otcWsUrl() {\n      var str = '';\n\n      if (this.$store.state.baseData.otcPublicInfo) {\n        str = this.$store.state.baseData.otcPublicInfo.otcChatWS;\n      }\n\n      return str; // return 'wss://ws2.chaindown.com/otc-chat/chatServer'\n    },\n    serverBtnDisabled: function serverBtnDisabled() {\n      var flag = true;\n\n      if (this.serverInp.length || this.serverBtnLoading) {\n        flag = false;\n      }\n\n      return flag;\n    },\n    userBtnDisabled: function userBtnDisabled() {\n      var flag = true;\n\n      if (this.userInp.length || this.userBtnLoading) {\n        flag = false;\n      }\n\n      return flag;\n    },\n    status: function status() {\n      if (this.commonData.status) {\n        return this.commonData.status.toString();\n      }\n\n      return '0';\n    },\n    chatUserHeight: function chatUserHeight() {\n      if (this.status === '5' && this.commonData.isComplainUser.toString() === '1') {\n        return this.chatHeight - 50 - 86 - 60;\n      }\n\n      return this.chatHeight - 86 - 60;\n    },\n    chatServerHeight: function chatServerHeight() {\n      return this.chatHeight - 50 - 60 - 6;\n    },\n    userSide: function userSide() {\n      var from = '';\n      var to = '';\n\n      if (this.commonData.side === 'BUY') {\n        from = this.commonData.buyer.uid.toString();\n        to = this.commonData.seller.uid.toString();\n      } else if (this.commonData.side === 'SELL') {\n        from = this.commonData.seller.uid.toString();\n        to = this.commonData.buyer.uid.toString();\n      }\n\n      return {\n        from: from,\n        to: to\n      };\n    }\n  },\n  beforeDestroy: function beforeDestroy() {\n    this.beforeDestroyMethods();\n  },\n  methods: {\n    beforeDestroyMethods: function beforeDestroyMethods() {\n      // 如果 商家聊天 ws已经创建好了，则给他断开\n      this.tab = '';\n\n      if (this.userWsReady) {\n        this.userWs.close();\n      }\n\n      this.userWs = null;\n      clearInterval(this.serverTimer);\n      clearTimeout(this.sendTimer);\n      clearTimeout(this.resetTimer);\n    },\n    goUid: function goUid(id) {\n      if (id) {\n        this.$router.push(\"/stranger?uid=\".concat(id));\n      }\n    },\n    userInpKeyup: function userInpKeyup(e) {\n      if (e.keyCode === 13) {\n        this.$bus.$emit('button-click', 'userButton');\n      }\n    },\n    serverInpKeyup: function serverInpKeyup(e) {\n      if (e.keyCode === 13) {\n        this.$bus.$emit('button-click', 'serverButton');\n      }\n    },\n    // aaa() {\n    //   this.userWs.close()\n    // },\n    userBtnClick: function userBtnClick() {\n      var _this = this;\n\n      if (this.userWsReady) {\n        this.userBtnLoading = true;\n        this.sendTimer = setTimeout(function () {\n          if (_this.userBtnLoading) {\n            _this.userBtnLoading = false;\n\n            if (_this.userWs && _this.userWsReady) {\n              _this.userWs.close();\n\n              _this.userInp = '';\n            }\n          }\n        }, 5000);\n        this.userTime = new Date().getTime();\n        this.userWs.send(JSON.stringify({\n          chatId: this.chatId,\n          message: {\n            content: this.userInp,\n            from: this.userSide.from,\n            to: this.userSide.to,\n            // 接收人,如果没有则置空,如果有多个接收人则用,分隔\n            orderId: this.commonData.sequence,\n            time: this.userTime\n          },\n          type: 'message'\n        }));\n      }\n    },\n    getUserData: function getUserData() {\n      var _this2 = this;\n\n      this.axios({\n        url: '/chatMsg/message',\n        method: 'post',\n        params: {\n          fromId: this.userSide.from,\n          toId: this.userSide.to,\n          orderId: this.commonData.sequence\n        },\n        hostType: 'otc'\n      }).then(function (data) {\n        if (data.code.toString() === '0') {\n          var arr = [];\n          data.data.forEach(function (v) {\n            var obj = {};\n\n            if (_this2.commonData.side === 'BUY') {\n              obj = v.fromId === _this2.userSide.from ? _this2.commonData.buyer : _this2.commonData.seller;\n            } else {\n              obj = v.fromId === _this2.userSide.from ? _this2.commonData.seller : _this2.commonData.buyer;\n            }\n\n            arr.push({\n              replayContent: v.content,\n              // 追 问内容\n              contentType: '1',\n              // 1-文字内容 2-图片url\n              userType: v.fromId === _this2.userSide.from ? '2' : '1',\n              // 用户类型：1-后台用户 2-前端用户\n              ctime: v.ctime,\n              // 提交时间\n              obj: obj\n            });\n          });\n          _this2.userData = arr;\n\n          _this2.$nextTick(function () {\n            _this2.$refs.userMessage.scrollTo({\n              y: '100%'\n            }, false);\n          });\n        } else {\n          _this2.$bus.$emit('tip', {\n            text: data.msg,\n            type: 'error'\n          });\n        }\n      });\n    },\n    // 创建商家聊天 / 创建ws\n    initUser: function initUser() {\n      var _this3 = this;\n\n      if (this.tab !== 'user') {\n        return;\n      }\n\n      this.getUserData(); // 获取历史数据\n      // 创建ws\n\n      if (this.otcWsUrl.length) {\n        this.userWs = null; // 重置\n\n        this.wsTime = new Date().getTime(); // 记录下创建时间 用于避免高频率创建\n\n        var str = this.userSide.from + this.userSide.to; // 自己的id + 对方的id\n        // console.log('create');\n        // 开始创建\n\n        this.userWs = new WebSocket(\"\".concat(this.otcWsUrl, \"/\").concat(window.btoa(str))); // 已经创建\n\n        this.userWs.onopen = function () {\n          if (_this3.tab !== 'user') {\n            return;\n          }\n\n          _this3.userWsReady = true;\n        }; // 接收数据\n\n\n        this.userWs.onmessage = function (ev) {\n          if (_this3.tab !== 'user') {\n            return;\n          }\n\n          if (ev.data) {\n            var data = JSON.parse(ev.data);\n            _this3.chatId = data.chatId;\n\n            if (data.message) {\n              if (Number(data.message.time) === Number(_this3.userTime)) {\n                _this3.userBtnLoading = false;\n                _this3.userInp = '';\n              }\n\n              var obj = {};\n\n              if (_this3.commonData.side === 'BUY') {\n                obj = data.message.from === _this3.userSide.from ? _this3.commonData.buyer : _this3.commonData.seller;\n              } else {\n                obj = data.message.from === _this3.userSide.from ? _this3.commonData.seller : _this3.commonData.buyer;\n              }\n\n              _this3.userData.push({\n                replayContent: data.message.content,\n                // 追 问内容\n                contentType: '1',\n                // 1-文字内容 2-图片url\n                userType: data.message.from === _this3.userSide.from ? '2' : '1',\n                // 用户类型：1-后台用户 2-前端用户\n                ctime: data.message.time,\n                // 提交时间\n                obj: obj\n              });\n\n              _this3.$nextTick(function () {\n                _this3.$refs.userMessage.scrollTo({\n                  y: '100%'\n                }, false);\n              });\n            }\n          }\n        }; // 一旦发现错误就关闭\n\n\n        this.userWs.onerror = function () {\n          if (_this3.tab !== 'user') {\n            return;\n          }\n\n          _this3.userWs.close();\n        }; // 错误处理\n\n\n        this.userWs.onclose = function () {\n          if (_this3.tab !== 'user') {\n            return;\n          }\n\n          _this3.userWsReady = false;\n          var nowTime = new Date().getTime();\n          var spk = nowTime - _this3.wsTime; // 避免高频率创建\n\n          if (spk > 3000) {\n            _this3.initUser();\n          } else {\n            // 如果切到客服 或者退出 这个倒计时就没有必要继续了\n            _this3.resetTimer = setTimeout(function () {\n              clearTimeout(_this3.resetTimer);\n\n              _this3.initUser();\n            }, 3000 - spk);\n          }\n        };\n      }\n    },\n    serverBtnClick: function serverBtnClick() {\n      var _this4 = this;\n\n      this.serverBtnLoading = true;\n      this.axios({\n        url: '/question/reply_create',\n        method: 'post',\n        params: {\n          rqId: this.commonData.complainId,\n          rqReplyContent: this.serverInp,\n          contentType: '1'\n        }\n      }).then(function (data) {\n        _this4.serverBtnLoading = false;\n\n        if (data.code.toString() === '0') {\n          _this4.serverScroll = true;\n\n          _this4.getServerData();\n\n          _this4.serverInp = '';\n        } else {\n          _this4.$bus.$emit('tip', {\n            text: data.msg,\n            type: 'error'\n          });\n        }\n      });\n    },\n    setTab: function setTab(v) {\n      this.tab = v;\n    },\n    getServerData: function getServerData() {\n      var _this5 = this;\n\n      clearInterval(this.serverTimer);\n      this.axiosServer();\n      this.serverTimer = setInterval(function () {\n        _this5.axiosServer(true);\n      }, 3000);\n    },\n    axiosServer: function axiosServer(auto) {\n      var _this6 = this;\n\n      var headers = {};\n\n      if (auto) {\n        headers['exchange-auto'] = '1';\n      }\n\n      this.axios({\n        url: '/question/details_problem',\n        headers: headers,\n        params: {\n          id: this.commonData.complainId\n        }\n      }).then(function (data) {\n        if (data.code.toString() === '0') {\n          var arr = [];\n\n          if (data.data.rqInfo) {\n            arr.push({\n              replayContent: data.data.rqInfo.rqDescribe,\n              // 追 问内容\n              contentType: '1',\n              // 1-文字内容 2-图片url\n              userType: '2',\n              // 用户类型：1-后台用户 2-前端用户\n              ctime: data.data.rqInfo.ctime // 提交时间\n\n            });\n          }\n\n          _this6.serverData = [].concat(arr, _toConsumableArray(data.data.rqReplyList));\n\n          _this6.$nextTick(function () {\n            if (_this6.serverScroll) {\n              _this6.serverScroll = false;\n\n              _this6.$refs.serverMessage.scrollTo({\n                y: '100%'\n              }, false);\n            }\n          });\n        } else {\n          _this6.$bus.$emit('tip', {\n            text: data.msg,\n            type: 'error'\n          });\n        }\n      });\n    },\n    // 上传图片\n    fileChange: function fileChange(e) {\n      var _this7 = this;\n\n      var fileSize = e.srcElement.files[0].size / 1024 / 1024;\n\n      if (fileSize <= 2) {\n        var from = new FormData();\n        from.append('file', this.$refs.fileInp.files[0], this.$refs.fileInp.files[0].name); // if (this.$store.state.baseData.publicInfo.uploadFlag === '1') {\n        //   ajaxUrl = window.HOST_API.updata_url\n        //   hostType = 'upload'\n        // }\n\n        this.axios({\n          url: 'common/upload_img',\n          headers: {\n            'Content-Type': 'multipart/form-data'\n          },\n          params: from,\n          method: 'post'\n        }).then(function (data) {\n          if (data.code === '0') {\n            _this7.axios({\n              url: '/question/reply_create',\n              method: 'post',\n              params: {\n                rqId: _this7.commonData.complainId,\n                rqReplyContent: data.data.filename,\n                contentType: '2'\n              }\n            }).then(function (cdata) {\n              if (cdata.code.toString() === '0') {\n                _this7.serverScroll = true;\n\n                _this7.getServerData();\n              } else {\n                _this7.$bus.$emit('tip', {\n                  text: cdata.msg,\n                  type: 'error'\n                });\n              }\n            });\n          } else {\n            _this7.$bus.$emit('tip', {\n              text: data.msg,\n              type: 'error'\n            });\n          }\n        });\n      } else {\n        this.$bus.$emit('tip', {\n          text: '请上传2MB以内的图片',\n          type: 'warning'\n        });\n      }\n    }\n  }\n};",{"version":3,"sources":["/Users/h/partTimeJob/blockchain-ui-privatization/PC/common-mixin/otcDetailOrder/chat/chat.js"],"names":["timeFn","data","userScrollOpt","detectResize","scrollPanel","initialScrollY","initialScrollX","scrollingX","scrollingY","speed","easing","undefined","verticalNativeBarPos","tab","serverData","serverInp","serverBtnLoading","serverTimer","serverScroll","userBtnLoading","userWs","userWsReady","userData","userInp","chatId","userTime","wsTime","sendTimer","resetTimer","chatHeight","userTimes","props","commonData","default","type","Object","isReady","Boolean","chatTop","Number","filters","setTime","v","Date","watch","status","isComplainUser","toString","clearTimeout","close","getServerData","clearInterval","initUser","computed","userVip","str","userInfo","otcCompanyInfo","userMess","companyLevel","$store","state","baseData","serverMy","obj","side","buyer","seller","otcWsUrl","otcPublicInfo","otcChatWS","serverBtnDisabled","flag","length","userBtnDisabled","chatUserHeight","chatServerHeight","userSide","from","to","uid","beforeDestroy","beforeDestroyMethods","methods","goUid","id","$router","push","userInpKeyup","e","keyCode","$bus","$emit","serverInpKeyup","userBtnClick","setTimeout","getTime","send","JSON","stringify","message","content","orderId","sequence","time","getUserData","axios","url","method","params","fromId","toId","hostType","then","code","arr","forEach","replayContent","contentType","userType","ctime","$nextTick","$refs","userMessage","scrollTo","y","text","msg","WebSocket","window","btoa","onopen","onmessage","ev","parse","onerror","onclose","nowTime","spk","serverBtnClick","rqId","complainId","rqReplyContent","setTab","axiosServer","setInterval","auto","headers","rqInfo","rqDescribe","rqReplyList","serverMessage","fileChange","fileSize","srcElement","files","size","FormData","append","fileInp","name","filename","cdata"],"mappings":"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","sourcesContent":["import { timeFn } from '@/utils';\r\n\r\nexport default {\r\n  data() {\r\n    return {\r\n      userScrollOpt: {\r\n        detectResize: true,\r\n        scrollPanel: {\r\n          initialScrollY: 999999,\r\n          initialScrollX: false,\r\n          scrollingX: true,\r\n          scrollingY: true,\r\n          speed: 300,\r\n          easing: undefined,\r\n          verticalNativeBarPos: 'right',\r\n        },\r\n      },\r\n      tab: '', // server客服 user商家\r\n      serverData: [],\r\n      serverInp: '',\r\n      serverBtnLoading: false,\r\n      serverTimer: null,\r\n      serverScroll: false,\r\n      userBtnLoading: false,\r\n      userWs: null,\r\n      userWsReady: false, //\r\n      userData: [], // 商户数据\r\n      userInp: '', // 商户框\r\n      chatId: '', // ws信息\r\n      userTime: null, // 发送ws消息的time 用于loding的过程\r\n      wsTime: null, // 用于重新连接ws\r\n      sendTimer: null, // 商家聊天 若五秒没从服务端返\r\n      resetTimer: null, // 商家聊天 若在三秒内重复创建\r\n      chatHeight: 684,\r\n      userTimes: null, // 发送消息倒计时\r\n    };\r\n  },\r\n  props: {\r\n    // 1-5 为正常流程  6是服务端状态  7为异常订单 8按3处理(客服介入强制使订单完成)\r\n    // 待支付1 已支付2 交易成功3 取消 4 申诉 5 打币中6 异常订单7 申诉处理结束8\r\n    commonData: { default: () => ({}), type: Object },\r\n    // 当前订单 是买数字货币BUY 还是卖数字货币SELL\r\n    isReady: { default: false, type: Boolean },\r\n    chatTop: { default: 0, type: Number },\r\n  },\r\n  filters: {\r\n    setTime(v) {\r\n      return timeFn(new Date(Number(v)), 'yyyy-MM-dd hh:mm:ss');\r\n    },\r\n  },\r\n  watch: {\r\n    status(v) {\r\n      if (v === '5' && this.commonData.isComplainUser.toString() === '1') {\r\n        this.tab = 'server';\r\n      } else {\r\n        this.tab = 'user';\r\n      }\r\n    },\r\n    tab(v) {\r\n      if (v === 'server') {\r\n        // 清除 商家聊天 若五秒没从服务端返回相同数据的后续操作\r\n        if (this.sendTimer) { clearTimeout(this.sendTimer); }\r\n        // 清除 商家聊天 若在三秒内重复创建ws的后续操作\r\n        if (this.resetTimer) { clearTimeout(this.resetTimer); }\r\n        // 如果 商家聊天 ws已经创建好了，则给他断开\r\n        if (this.userWsReady) { this.userWs.close(); }\r\n        // 获取 客服聊天数据\r\n        this.getServerData();\r\n        this.serverScroll = true;\r\n      } else if (v === 'user') {\r\n        // 清除 循环请求客服聊天数据\r\n        if (this.serverTimer) { clearInterval(this.serverTimer); }\r\n        // 创建ws并且请求历史数据\r\n        this.initUser();\r\n      }\r\n    },\r\n  },\r\n  computed: {\r\n    userVip() {\r\n      let str = '';\r\n      if (this.userInfo && this.userInfo.otcCompanyInfo) {\r\n        if (Number(this.userInfo.otcCompanyInfo.status)) {\r\n          if (this.userMess.companyLevel === 1) {\r\n            str = `<svg class=\"icon icon-16\" aria-hidden=\"true\">\r\n              <use xlink:href=\"#icon-c_16\"></use>\r\n            </svg>`;\r\n          } else if (this.userMess.companyLevel === 2) {\r\n            str = `<svg class=\"icon icon-16\" aria-hidden=\"true\">\r\n              <use xlink:href=\"#icon-c_17\"></use>\r\n            </svg>`;\r\n          }\r\n        }\r\n      }\r\n      return str;\r\n    },\r\n    userInfo() { return this.$store.state.baseData.userInfo; },\r\n    serverMy() {\r\n      let obj = {};\r\n      if (this.commonData.side === 'BUY') {\r\n        obj = this.commonData.buyer;\r\n      } else {\r\n        obj = this.commonData.seller;\r\n      }\r\n      return obj;\r\n    },\r\n    userMess() {\r\n      let obj = {};\r\n      if (this.commonData.side === 'BUY') {\r\n        obj = this.commonData.seller;\r\n      } else if (this.commonData.side === 'SELL') {\r\n        obj = this.commonData.buyer;\r\n      }\r\n      return obj;\r\n    },\r\n    otcWsUrl() {\r\n      let str = '';\r\n      if (this.$store.state.baseData.otcPublicInfo) {\r\n        str = this.$store.state.baseData.otcPublicInfo.otcChatWS;\r\n      }\r\n      return str;\r\n      // return 'wss://ws2.chaindown.com/otc-chat/chatServer'\r\n    },\r\n    serverBtnDisabled() {\r\n      let flag = true;\r\n      if (this.serverInp.length || this.serverBtnLoading) {\r\n        flag = false;\r\n      }\r\n      return flag;\r\n    },\r\n    userBtnDisabled() {\r\n      let flag = true;\r\n      if (this.userInp.length || this.userBtnLoading) {\r\n        flag = false;\r\n      }\r\n      return flag;\r\n    },\r\n    status() {\r\n      if (this.commonData.status) {\r\n        return this.commonData.status.toString();\r\n      }\r\n      return '0';\r\n    },\r\n    chatUserHeight() {\r\n      if (this.status === '5' && this.commonData.isComplainUser.toString() === '1') {\r\n        return this.chatHeight - 50 - 86 - 60;\r\n      }\r\n      return this.chatHeight - 86 - 60;\r\n    },\r\n    chatServerHeight() {\r\n      return this.chatHeight - 50 - 60 - 6;\r\n    },\r\n    userSide() {\r\n      let from = '';\r\n      let to = '';\r\n      if (this.commonData.side === 'BUY') {\r\n        from = this.commonData.buyer.uid.toString();\r\n        to = this.commonData.seller.uid.toString();\r\n      } else if (this.commonData.side === 'SELL') {\r\n        from = this.commonData.seller.uid.toString();\r\n        to = this.commonData.buyer.uid.toString();\r\n      }\r\n      return {\r\n        from, to,\r\n      };\r\n    },\r\n  },\r\n  beforeDestroy() {\r\n    this.beforeDestroyMethods();\r\n  },\r\n  methods: {\r\n    beforeDestroyMethods() {\r\n      // 如果 商家聊天 ws已经创建好了，则给他断开\r\n      this.tab = '';\r\n      if (this.userWsReady) { this.userWs.close(); }\r\n      this.userWs = null;\r\n      clearInterval(this.serverTimer);\r\n      clearTimeout(this.sendTimer);\r\n      clearTimeout(this.resetTimer);\r\n    },\r\n    goUid(id) {\r\n      if (id) {\r\n        this.$router.push(`/stranger?uid=${id}`);\r\n      }\r\n    },\r\n    userInpKeyup(e) {\r\n      if (e.keyCode === 13) {\r\n        this.$bus.$emit('button-click', 'userButton');\r\n      }\r\n    },\r\n    serverInpKeyup(e) {\r\n      if (e.keyCode === 13) {\r\n        this.$bus.$emit('button-click', 'serverButton');\r\n      }\r\n    },\r\n    // aaa() {\r\n    //   this.userWs.close()\r\n    // },\r\n    userBtnClick() {\r\n      if (this.userWsReady) {\r\n        this.userBtnLoading = true;\r\n        this.sendTimer = setTimeout(() => {\r\n          if (this.userBtnLoading) {\r\n            this.userBtnLoading = false;\r\n            if (this.userWs && this.userWsReady) {\r\n              this.userWs.close();\r\n              this.userInp = '';\r\n            }\r\n          }\r\n        }, 5000);\r\n        this.userTime = new Date().getTime();\r\n        this.userWs.send(JSON.stringify({\r\n          chatId: this.chatId,\r\n          message: {\r\n            content: this.userInp,\r\n            from: this.userSide.from,\r\n            to: this.userSide.to, // 接收人,如果没有则置空,如果有多个接收人则用,分隔\r\n            orderId: this.commonData.sequence,\r\n            time: this.userTime,\r\n          },\r\n          type: 'message',\r\n        }));\r\n      }\r\n    },\r\n    getUserData() {\r\n      this.axios({\r\n        url: '/chatMsg/message',\r\n        method: 'post',\r\n        params: {\r\n          fromId: this.userSide.from,\r\n          toId: this.userSide.to,\r\n          orderId: this.commonData.sequence,\r\n        },\r\n        hostType: 'otc',\r\n      }).then((data) => {\r\n        if (data.code.toString() === '0') {\r\n          const arr = [];\r\n          data.data.forEach((v) => {\r\n            let obj = {};\r\n            if (this.commonData.side === 'BUY') {\r\n              obj = v.fromId === this.userSide.from\r\n                ? this.commonData.buyer\r\n                : this.commonData.seller;\r\n            } else {\r\n              obj = v.fromId === this.userSide.from\r\n                ? this.commonData.seller\r\n                : this.commonData.buyer;\r\n            }\r\n            arr.push({\r\n              replayContent: v.content, // 追 问内容\r\n              contentType: '1', // 1-文字内容 2-图片url\r\n              userType: v.fromId === this.userSide.from ? '2' : '1', // 用户类型：1-后台用户 2-前端用户\r\n              ctime: v.ctime, // 提交时间\r\n              obj,\r\n            });\r\n          });\r\n          this.userData = arr;\r\n          this.$nextTick(() => {\r\n            this.$refs.userMessage.scrollTo({\r\n              y: '100%',\r\n            }, false);\r\n          });\r\n        } else {\r\n          this.$bus.$emit('tip', { text: data.msg, type: 'error' });\r\n        }\r\n      });\r\n    },\r\n    // 创建商家聊天 / 创建ws\r\n    initUser() {\r\n      if (this.tab !== 'user') { return; }\r\n      this.getUserData(); // 获取历史数据\r\n      // 创建ws\r\n      if (this.otcWsUrl.length) {\r\n        this.userWs = null; // 重置\r\n        this.wsTime = new Date().getTime(); // 记录下创建时间 用于避免高频率创建\r\n        const str = this.userSide.from + this.userSide.to; // 自己的id + 对方的id\r\n        // console.log('create');\r\n        // 开始创建\r\n        this.userWs = new WebSocket(`${this.otcWsUrl}/${window.btoa(str)}`);\r\n        // 已经创建\r\n        this.userWs.onopen = (() => {\r\n          if (this.tab !== 'user') { return; }\r\n          this.userWsReady = true;\r\n        });\r\n        // 接收数据\r\n        this.userWs.onmessage = ((ev) => {\r\n          if (this.tab !== 'user') { return; }\r\n          if (ev.data) {\r\n            const data = JSON.parse(ev.data);\r\n            this.chatId = data.chatId;\r\n            if (data.message) {\r\n              if (Number(data.message.time) === Number(this.userTime)) {\r\n                this.userBtnLoading = false;\r\n                this.userInp = '';\r\n              }\r\n              let obj = {};\r\n              if (this.commonData.side === 'BUY') {\r\n                obj = data.message.from === this.userSide.from\r\n                  ? this.commonData.buyer\r\n                  : this.commonData.seller;\r\n              } else {\r\n                obj = data.message.from === this.userSide.from\r\n                  ? this.commonData.seller\r\n                  : this.commonData.buyer;\r\n              }\r\n              this.userData.push({\r\n                replayContent: data.message.content, // 追 问内容\r\n                contentType: '1', // 1-文字内容 2-图片url\r\n                userType: data.message.from === this.userSide.from ? '2' : '1', // 用户类型：1-后台用户 2-前端用户\r\n                ctime: data.message.time, // 提交时间\r\n                obj,\r\n              });\r\n              this.$nextTick(() => {\r\n                this.$refs.userMessage.scrollTo({\r\n                  y: '100%',\r\n                }, false);\r\n              });\r\n            }\r\n          }\r\n        });\r\n        // 一旦发现错误就关闭\r\n        this.userWs.onerror = (() => {\r\n          if (this.tab !== 'user') { return; }\r\n          this.userWs.close();\r\n        });\r\n        // 错误处理\r\n        this.userWs.onclose = (() => {\r\n          if (this.tab !== 'user') { return; }\r\n          this.userWsReady = false;\r\n          const nowTime = new Date().getTime();\r\n          const spk = nowTime - this.wsTime;\r\n          // 避免高频率创建\r\n          if (spk > 3000) {\r\n            this.initUser();\r\n          } else {\r\n            // 如果切到客服 或者退出 这个倒计时就没有必要继续了\r\n            this.resetTimer = setTimeout(() => {\r\n              clearTimeout(this.resetTimer);\r\n              this.initUser();\r\n            }, 3000 - spk);\r\n          }\r\n        });\r\n      }\r\n    },\r\n    serverBtnClick() {\r\n      this.serverBtnLoading = true;\r\n      this.axios({\r\n        url: '/question/reply_create',\r\n        method: 'post',\r\n        params: {\r\n          rqId: this.commonData.complainId,\r\n          rqReplyContent: this.serverInp,\r\n          contentType: '1',\r\n        },\r\n      }).then((data) => {\r\n        this.serverBtnLoading = false;\r\n        if (data.code.toString() === '0') {\r\n          this.serverScroll = true;\r\n          this.getServerData();\r\n          this.serverInp = '';\r\n        } else {\r\n          this.$bus.$emit('tip', { text: data.msg, type: 'error' });\r\n        }\r\n      });\r\n    },\r\n    setTab(v) {\r\n      this.tab = v;\r\n    },\r\n    getServerData() {\r\n      clearInterval(this.serverTimer);\r\n      this.axiosServer();\r\n      this.serverTimer = setInterval(() => {\r\n        this.axiosServer(true);\r\n      }, 3000);\r\n    },\r\n    axiosServer(auto) {\r\n      const headers = {};\r\n      if (auto) {\r\n        headers['exchange-auto'] = '1';\r\n      }\r\n      this.axios({\r\n        url: '/question/details_problem',\r\n        headers,\r\n        params: {\r\n          id: this.commonData.complainId,\r\n        },\r\n      }).then((data) => {\r\n        if (data.code.toString() === '0') {\r\n          const arr = [];\r\n          if (data.data.rqInfo) {\r\n            arr.push({\r\n              replayContent: data.data.rqInfo.rqDescribe, // 追 问内容\r\n              contentType: '1', // 1-文字内容 2-图片url\r\n              userType: '2', // 用户类型：1-后台用户 2-前端用户\r\n              ctime: data.data.rqInfo.ctime, // 提交时间\r\n            });\r\n          }\r\n          this.serverData = [...arr, ...data.data.rqReplyList];\r\n          this.$nextTick(() => {\r\n            if (this.serverScroll) {\r\n              this.serverScroll = false;\r\n              this.$refs.serverMessage.scrollTo({\r\n                y: '100%',\r\n              }, false);\r\n            }\r\n          });\r\n        } else {\r\n          this.$bus.$emit('tip', { text: data.msg, type: 'error' });\r\n        }\r\n      });\r\n    },\r\n    // 上传图片\r\n    fileChange(e) {\r\n      const fileSize = e.srcElement.files[0].size / 1024 / 1024;\r\n      if (fileSize <= 2) {\r\n        const from = new FormData();\r\n        from.append('file', this.$refs.fileInp.files[0], this.$refs.fileInp.files[0].name);\r\n        // if (this.$store.state.baseData.publicInfo.uploadFlag === '1') {\r\n        //   ajaxUrl = window.HOST_API.updata_url\r\n        //   hostType = 'upload'\r\n        // }\r\n        this.axios({\r\n          url: 'common/upload_img',\r\n          headers: { 'Content-Type': 'multipart/form-data' },\r\n          params: from,\r\n          method: 'post',\r\n        }).then((data) => {\r\n          if (data.code === '0') {\r\n            this.axios({\r\n              url: '/question/reply_create',\r\n              method: 'post',\r\n              params: {\r\n                rqId: this.commonData.complainId,\r\n                rqReplyContent: data.data.filename,\r\n                contentType: '2',\r\n              },\r\n            }).then((cdata) => {\r\n              if (cdata.code.toString() === '0') {\r\n                this.serverScroll = true;\r\n                this.getServerData();\r\n              } else {\r\n                this.$bus.$emit('tip', { text: cdata.msg, type: 'error' });\r\n              }\r\n            });\r\n          } else {\r\n            this.$bus.$emit('tip', { text: data.msg, type: 'error' });\r\n          }\r\n        });\r\n      } else {\r\n        this.$bus.$emit('tip', { text: '请上传2MB以内的图片', type: 'warning' });\r\n      }\r\n    },\r\n  },\r\n};\r\n"]}]}